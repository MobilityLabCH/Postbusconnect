
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PostBus Connect — MagicPass Express</title>
<link rel="stylesheet" href="assets/brand.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
<header>
  <div class="head">
    <div class="logo">P</div>
    <div class="brand">PostBus Connect</div>
    <div class="spacer"></div>
    <div>Powered by <b>MobilityLab</b> — Opéré par <b>CarPostal</b></div>
  </div>
</header>

<section class="hero">
  <div class="hero-in">
    <h1 class="title">MagicPass Express · Navettes directes vers les pistes</h1>
    <p class="subtitle">Quand les transports publics sont trop longs ou trop compliqués, on propose des navettes directes au départ des villes romandes vers les stations. Horaires alignés avec les remontées, confort, porte-skis & confirmation instantanée.</p>
    <div class="cta-row">
      <a href="#plan" class="btn primary">Planifier un trajet</a>
      <a href="#why" class="btn">Pourquoi c’est mieux ?</a>
    </div>
  </div>
</section>

<div class="wrap" id="why">
  <div class="grid-3">
    <div class="panel">
      <h3>✨ Avantages clés</h3>
      <ul>
        <li>⏱ <b>+40–80 min</b> gagnées sur les trajets longs</li>
        <li>🧩 <b>0 correspondance</b> : monte & détends-toi</li>
        <li>🎟 <b>Prix MagicPass</b> · confort · porte-skis</li>
        <li>🌱 <b>-75% CO₂</b> vs. voiture (trajets mutualisés)</li>
      </ul>
    </div>
    <div class="panel">
      <h3>⚙️ Comment ça marche</h3>
      <ul>
        <li>1. Choisis <b>départ</b> et <b>destination</b></li>
        <li>2. Si TP trop lents, on suggère la <b>navette directe</b></li>
        <li>3. Réserve en 2 clics · confirmation immédiate</li>
        <li>4. Départs <b>ven/sam/dim</b> en saison de ski</li>
      </ul>
    </div>
    <div class="panel">
      <h3>🚗 Pourquoi pas la voiture / TP ?</h3>
      <ul>
        <li>Voiture : bouchons, parkings chers, stress</li>
        <li>TP : 2–3 correspondances, marche, lenteur</li>
        <li>Navette : directe, horaire optimisé, confort</li>
      </ul>
    </div>
  </div>
</div>

<div class="wrap" id="plan">
  <div class="panel">
    <h3>🧭 Planifie ton trajet</h3>
    <div class="toolbar">
      <div class="field"><input id="from" placeholder="Départ (ex. Lausanne)" value="Lausanne"></div>
      <div class="field"><input id="to" placeholder="Destination (ex. Ovronnaz)" value="Ovronnaz"></div>
      <button class="btn primary" id="analyze">Analyser</button>
    </div>
    <div class="deck" id="deck" style="margin-top:10px;display:flex;gap:10px;overflow:auto;">
      <div class="btn" data-from="Lausanne" data-to="Ovronnaz">Lausanne → Ovronnaz</div>
      <div class="btn" data-from="Genève" data-to="Crans-Montana">Genève → Crans‑Montana</div>
      <div class="btn" data-from="Fribourg" data-to="Anzère">Fribourg → Anzère</div>
      <div class="btn" data-from="Neuchâtel" data-to="Nax-Mont-Noble">Neuchâtel → Nax</div>
      <div class="btn" data-from="Sion" data-to="Zinal">Sion → Zinal</div>
      <div class="btn" data-from="Lausanne" data-to="Leukerbad">Lausanne → Leukerbad</div>
    </div>
  </div>
</div>

<div class="wrap">
  <main id="routes" aria-live="polite"></main>
  <div id="map" role="img" aria-label="Carte des itinéraires"></div>
  <footer>© 2025 PostBus Connect — <b>Powered by MobilityLab</b> — Données & exploitation : CarPostal — Démo.</footer>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-card">
    <div class="modal-head">
      <h3 id="modalTitle" style="margin:0">Réserver la navette</h3>
      <button class="x" id="closeModal">Fermer</button>
    </div>
    <div class="modal-body">
      <div class="note" id="modalNote">Navette directe MagicPass Express — retours après la dernière piste.</div>
      <div class="row">
        <div class="field"><label class="note">Date</label><input id="mdate" type="date"></div>
        <div class="field"><label class="note">Personnes</label>
          <select id="mpax"><option>1</option><option selected>2</option><option>3</option><option>4</option></select>
        </div>
      </div>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div class="price" id="priceInfo">CHF —</div>
          <div class="note" id="availabilityInfo">Calcul des places…</div>
        </div>
        <button class="btn primary" id="confirmBtn">Réserver (simulation)</button>
      </div>
    </div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s); const $$=s=>[...document.querySelectorAll(s)];
function clear(el){while(el.firstChild)el.removeChild(el.firstChild);}
function clampPx(n){return Math.max(8,Math.round(n));}
function nextSaturday(d=new Date()){const diff=(6-d.getDay()+7)%7||7;const n=new Date(d);n.setDate(d.getDate()+diff);return n;}
function fmtDate(d){return d.toISOString().slice(0,10);}

let DB=[];
async function loadDB(){
  const res=await fetch('data/routes.json',{cache:'no-store'});
  DB=await res.json();
}

function findRoute(from,to){
  return DB.find(r=>r.from.toLowerCase()===from.toLowerCase() && r.to.toLowerCase()===to.toLowerCase());
}

function computeTimes(route){
  const car = Math.round(route.car_min*1.1); // trafic moyen
  const pt  = Math.round(route.pt_min);
  const shuttle = Math.max(Math.round(car - 40 + 6), Math.round(car*0.6));
  return {car,pt,shuttle};
}

function barHeights(times){
  const max=Math.max(times.car,times.pt,times.shuttle)||1;
  const H=64, scale=x=>Math.max(8,Math.round(x/max*H));
  return {car:scale(times.car), pt:scale(times.pt), shuttle:scale(times.shuttle)};
}

let map, mapLayers=[];
function initMap(){
  map = L.map('map').setView([46.8182,8.2275],8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
}
function plotOnMap(r){
  mapLayers.forEach(l=>map.removeLayer(l)); mapLayers=[];
  if(r.from_coords && r.to_coords){
    const m1=L.marker(r.from_coords).addTo(map).bindPopup(r.from);
    const m2=L.marker(r.to_coords).addTo(map).bindPopup(r.to);
    mapLayers.push(m1,m2);
    const b=L.latLngBounds([r.from_coords,r.to_coords]); map.fitBounds(b.pad(0.2));
  }
}

function simulateInventory(key,dateISO){
  const base=36, seed=[...key+dateISO].reduce((a,c)=>a+c.charCodeAt(0),0);
  const wd=new Date(dateISO).getDay(); const demand=(seed%18)+(wd===6||wd===0?10:4);
  const taken=Math.min(base-3,demand+(seed%6)); const left=Math.max(0,base-taken);
  const price=29+((seed%4)*3);
  return {left,price};
}

function cardTemplate(r){
  const t=computeTimes(r);
  const inv=simulateInventory(r.id, $('#mdate').value);
  const seats = inv.left ? `${inv.left} places · dès CHF ${inv.price}` : 'Complet';
  const recommended = (t.pt - t.shuttle >= 30);
  const h=barHeights(t);
  const el=document.createElement('article'); el.className='card';
  el.innerHTML=`
    <div class="image"><img src="${r.image}" alt="${r.to}"></div>
    <div class="badge ${recommended?'':'warn'}">${recommended?`+${t.pt - t.shuttle} min gagnées`:'Gain limité'}</div>
    <div class="content">
      <h3 class="route">${r.from} → ${r.to}</h3>
      <div class="details">🚗 <b>${t.car} min</b> · 🚌 TP <b>${t.pt} min</b> · 🟢 Navette <b>${t.shuttle} min</b> · 🎟 <b>${seats}</b></div>
      <div class="mini">
        <div class="bar car" style="height:${h.car}px">V</div>
        <div class="bar tp"  style="height:${h.pt}px">TP</div>
        <div class="bar sh"  style="height:${h.shuttle}px">Nav</div>
      </div>
      <div class="cta">
        <button class="btn primary reserve">Réserver</button>
        <button class="btn detailsBtn">Voir sur la carte</button>
      </div>
    </div>`;
  el.querySelector('.reserve').addEventListener('click',()=>openModal(r));
  el.querySelector('.detailsBtn').addEventListener('click',()=>plotOnMap(r));
  return el;
}

function analyze(from,to){
  const route=findRoute(from,to);
  clear($('#routes'));
  if(!route){ $('#routes').innerHTML='<div class="panel">Aucun itinéraire trouvé pour cette combinaison.</div>'; return; }
  $('#routes').appendChild(cardTemplate(route));
  plotOnMap(route);
}

function bindUI(){
  $('#deck').addEventListener('click',e=>{
    const b=e.target.closest('.btn'); if(!b) return;
    $('#from').value=b.dataset.from; $('#to').value=b.dataset.to;
    analyze($('#from').value,$('#to').value);
  });
  $('#analyze').addEventListener('click',()=>analyze($('#from').value,$('#to').value));
}

/* modal */
function openModal(r){
  const modal=$('#modal'); modal.classList.add('open');
  $('#modalTitle').textContent=`Réserver : ${r.from} → ${r.to}`;
  const inv=simulateInventory(r.id, $('#mdate').value);
  $('#priceInfo').textContent=inv.left?`CHF ${inv.price} / pers.`:'Complet';
  $('#availabilityInfo').textContent=inv.left?`${inv.left} places restantes`:'Aucune place disponible';
  $('#confirmBtn').disabled=!inv.left;
}
function closeModal(){ $('#modal').classList.remove('open'); }
$('#closeModal').addEventListener('click',closeModal);
$('#modal').addEventListener('click',e=>{ if(e.target.id==='modal') closeModal(); });
$('#mdate').value = (function(){const d=new Date(); d.setDate(d.getDate()+ (6-d.getDay()+7)%7 || 7); return d.toISOString().slice(0,10);})();
$('#confirmBtn').addEventListener('click',()=>{ alert('🎉 Réservation simulée !'); closeModal(); });

(async function init(){
  await loadDB(); initMap(); bindUI();
  analyze('Lausanne','Ovronnaz');
})();
</script>
</body>
</html>
