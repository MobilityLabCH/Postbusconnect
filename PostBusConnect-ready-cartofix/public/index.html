<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PostBus Connect â€” MagicPass Express</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    :root{--bg:#0b0d10;--brand:#1DB954;--muted:#aeb4c2;--panel:#10141a;--ring:#1b2030;--accent:#ffd300;}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:50;background:#0c0f14d8;backdrop-filter:blur(6px);border-bottom:1px solid #121820}
    .head{max-width:1180px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center}
    .logo{width:32px;height:32px;border-radius:8px;background:var(--accent);display:grid;place-items:center;color:#121111;font-weight:900}
    .brand{font-weight:900;font-size:1.25rem}
    .tag{color:#cfe7d8;margin-left:auto}.tag b{color:var(--brand)}
    .wrap{max-width:1180px;margin:0 auto;padding:16px}
    .hero{padding:26px 16px;background:radial-gradient(1200px 400px at 90% -20%,#16e16e22,transparent 60%),linear-gradient(180deg,#0e1218,#0b0d10)}
    h1{margin:.2rem 0 .6rem;font-size:clamp(1.8rem,4.6vw,2.6rem)}
    p.lead{color:#cfd9ea;max-width:860px;margin:.2rem 0 0}
    .toolbar{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-top:14px}
    input,button{font-size:1rem;border-radius:12px}
    input{background:#0e1116;border:1px solid #1b2030;color:#e9eef7;padding:12px 14px}
    button{border:0;padding:12px 14px;font-weight:800;cursor:pointer}
    .primary{background:linear-gradient(90deg,#16c85d,#22e06e);color:#06250f}
    .deck{display:flex;gap:10px;overflow:auto;padding:10px 0}
    .suggest{flex:0 0 auto;background:#0e1116;border:1px solid #1b2030;border-radius:10px;padding:10px;cursor:pointer;white-space:nowrap}
    main.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;margin-top:14px}
    .card{position:relative;background:#12151b;border:1px solid var(--ring);border-radius:14px;overflow:hidden}
    .image{height:190px;background:#0e1217}
    .image img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{position:absolute;top:10px;left:10px;background:rgba(29,185,84,.95);border-radius:999px;padding:6px 10px;font-size:.78rem;color:#05250f;font-weight:900}
    .badge.warn{background:#ff5b5b;color:#1a0b0b}
    .content{padding:12px}
    .details{color:var(--muted);margin:.35rem 0 .6rem}
    .mini{height:72px;background:#0e1116;border:1px solid #1b2030;border-radius:10px;display:flex;align-items:flex-end;gap:6px;padding:6px;overflow:hidden}
    .bar{flex:1;min-width:26px;display:flex;align-items:flex-end;justify-content:center;border-radius:6px 6px 0 0;color:#000;font-size:.75rem;font-weight:900}
    .car{background:#9aa0a6}.tp{background:#ff5b5b}.sh{background:#1DB954;color:#05290f}
    .cta{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    #map{height:420px;border:1px solid #171b22;border-radius:16px;margin-top:16px}
    footer{border-top:1px solid #12161f;color:#9fb2c7;text-align:center;padding:14px 12px;margin-top:22px}
    @media (max-width:820px){.toolbar{grid-template-columns:1fr}.tag{display:none}#map{height:300px} .image{height:46vw;max-height:220px}}
  </style>
</head>
<body>
<header>
  <div class="head">
    <div class="logo">P</div><div class="brand">PostBus Connect</div>
    <div class="tag">Powered by <b>MobilityLab</b> â€” OpÃ©rÃ© par <b>CarPostal</b></div>
  </div>
</header>

<section class="hero">
  <div class="wrap">
    <h1>MagicPass Express â€” Navettes directes vers les pistes</h1>
    <p class="lead">Quand les TP sont trop longs, la navette directe optimise ton trajet. Confort, porte-skis, horaires alignÃ©s aux remontÃ©es, prix spÃ©cial MagicPass.</p>
    <div class="toolbar">
      <input id="from" placeholder="DÃ©part (ex. Lausanne)" value="Lausanne">
      <input id="to" placeholder="Destination (ex. Ovronnaz)" value="Ovronnaz">
      <button class="primary" id="analyze">Analyser</button>
    </div>
    <div class="deck" id="deck"></div>
  </div>
</section>

<div class="wrap">
  <main class="grid" id="routes"></main>
  <div id="map"></div>
  <footer>Â© 2025 PostBus Connect â€” <b>MobilityLab</b> & CarPostal â€” DÃ©mo</footer>
</div>

<script>
  const $=s=>document.querySelector(s); const $$=s=>[...document.querySelectorAll(s)];
  const grid=$('#routes'); const fromI=$('#from'); const toI=$('#to'); const analyzeBtn=$('#analyze');
  let ROUTES=[], SUGGEST=[];

  fetch('data/routes.json').then(r=>r.json()).then(data=>{
    ROUTES=data.routes; SUGGEST=data.suggest;
    const deck=$('#deck'); deck.innerHTML = SUGGEST.map(s=>`<div class="suggest" data-from="${s.from}" data-to="${s.to}">${s.from} â†’ ${s.to}</div>`).join('');
  });

  // Leaflet + CartoCDN provider (fallback OSM)
  const map = L.map('map').setView([46.8182,8.2275],8);
  const carto = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    subdomains: 'abcd', maxZoom: 19, attribution: 'Â© OpenStreetMap, Â© CARTO'
  }).addTo(map);
  carto.on('tileerror', ()=>{
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'Â© OpenStreetMap'}).addTo(map);
  });

  let mapLayers=[];
  function plot(from,to,b) {
    mapLayers.forEach(m=>map.removeLayer(m)); mapLayers=[];
    if(b.from_coords && b.to_coords) {
      const m1=L.marker([b.from_coords.lat,b.from_coords.lon]).addTo(map).bindPopup(from);
      const m2=L.marker([b.to_coords.lat,b.to_coords.lon]).addTo(map).bindPopup(to);
      mapLayers.push(m1,m2);
      const bounds=L.latLngBounds([m1.getLatLng(),m2.getLatLng()]); map.fitBounds(bounds.pad(0.2));
    }
  }

  function minih(times){
    const max=Math.max(times.car_min,times.pt_min,times.shuttle_min)||1, H=64;
    const s=x=>Math.max(8,Math.round(x/max*H));
    return {car:s(times.car_min),pt:s(times.pt_min),sh:s(times.shuttle_min)};
  }

  function card(r){
    const h=minih(r);
    const rec=(r.pt_min - r.shuttle_min >= 30);
    const article=document.createElement('article'); article.className='card';
    article.innerHTML=`
      <div class="image">${r.image?'<img src="'+r.image+'" alt="'+r.to+'">':'<div class="placeholder"></div>'}</div>
      <div class="badge ${rec?'':'warn'}">${rec?('+'+(r.pt_min - r.shuttle_min)+' min gagnÃ©es'):'Gain limitÃ©'}</div>
      <div class="content">
        <h3>${r.from} â†’ ${r.to}</h3>
        <div class="details">ðŸš— ${r.car_min} min Â· ðŸšŒ TP ${r.pt_min} min Â· ðŸŸ¢ Navette ${r.shuttle_min} min Â· ðŸŽŸ dÃ¨s CHF ${r.price_chf}</div>
        <div class="mini">
          <div class="bar car" style="height:${h.car}px">V</div>
          <div class="bar tp"  style="height:${h.pt}px">TP</div>
          <div class="bar sh"  style="height:${h.sh}px">Nav</div>
        </div>
        <div class="cta">
          <button class="primary" data-book>RÃ©server</button>
          <button data-details>Voir sur la carte</button>
        </div>
      </div>`;
    article.querySelector('[data-book]').addEventListener('click',()=>alert('RÃ©servation simulÃ©e âœ…'));
    article.querySelector('[data-details]').addEventListener('click',()=>plot(r.from,r.to,r));
    return article;
  }

  function render(from,to){
    const key=`${from}|${to}`;
    const found = ROUTES.find(x=>x.key===key);
    grid.innerHTML='';
    const r = found || {from,to,car_min:100,pt_min:170,shuttle_min:70,price_chf:32, image:null};
    grid.appendChild(card(r));
    plot(r.from,r.to,r);
  }

  $('#deck').addEventListener('click',e=>{const s=e.target.closest('.suggest'); if(!s) return; fromI.value=s.dataset.from; toI.value=s.dataset.to; analyzeBtn.click();});
  analyzeBtn.addEventListener('click',()=>render(fromI.value.trim(), toI.value.trim()));
  // initial
  setTimeout(()=>analyzeBtn.click(), 300);
</script>
</body>
</html>